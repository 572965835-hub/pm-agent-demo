import streamlit as st
from openai import OpenAI

# 1. é…ç½® Kimi (Moonshot) API å®¢æˆ·ç«¯
client = OpenAI(
    api_key=st.secrets["MOONSHOT_API_KEY"],
    base_url="https://api.moonshot.cn/v1",
)

st.set_page_config(page_title="PIA æ™ºèƒ½å·¥å• Agent", page_icon="ğŸ¤–", layout="centered")
st.markdown("<style>#MainMenu {visibility: hidden;} footer {visibility: hidden;}</style>", unsafe_allow_html=True)

st.title("ğŸ¤– ç¡¬ä»¶äº¤ä»˜ PIA æ™ºèƒ½å¤æ ¸ Agent")
st.caption("Powered by Kimi | åªæœ‰æ»¡è¶³ç°è±¡(P)ã€åŠ¨ä½œäº¤å‰éªŒè¯(I)ã€ç°çŠ¶(A)çš„é€»è¾‘é—­ç¯ï¼Œæ‰ä¼šç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šã€‚")
st.divider()

# 2. æ³¨å…¥ä½ çš„çµé­‚ï¼šPIA æ ¸å¿ƒ Prompt
SYSTEM_PROMPT = """
ä½ ç°åœ¨æ˜¯ä¸€ä½èµ„æ·±çš„æœåŠ¡å™¨ç¡¬ä»¶äº¤ä»˜é¡¹ç›®ç»ç†ï¼ˆPMï¼‰ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯ï¼šä½œä¸ºã€æ™ºèƒ½å·¥å•å¤æ ¸åŠ©æ‰‹ã€‘ï¼Œé€šè¿‡å¤šè½®å¯¹è¯ï¼Œå®¡æŸ¥ç°åœºå·¥ç¨‹å¸ˆæäº¤çš„æ•…éšœæ’æŸ¥è®°å½•ï¼Œç¡®ä¿å…¶é€»è¾‘ä¸¥å¯†ã€è¯æ®å……åˆ†ï¼Œå¹¶æœ€ç»ˆç”Ÿæˆæ ‡å‡†åŒ–äº¤ä»˜æŠ¥å‘Šã€‚

# Core Framework (æ ¸å¿ƒå®¡æ ¸æ¡†æ¶ï¼šPIA æ¨¡å‹)
ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ã€PIA æ¨¡å‹ã€‘çš„æ ‡å‡†ï¼Œé€ä¸€æ ¸å¯¹å·¥ç¨‹å¸ˆè¾“å…¥çš„ä¿¡æ¯ã€‚ä»»ä½•ä¸€ä¸ªç¯èŠ‚ç¼ºå¤±æˆ–å­˜åœ¨é€»è¾‘æ–­å±‚ï¼Œä½ éƒ½å¿…é¡»è¿›è¡Œæ‹¦æˆªå¹¶è¿½é—®ã€‚
1. ã€P - Phenomenon (åˆå§‹ç°è±¡)ã€‘å¿…é¡»åŒ…å«æ˜ç¡®çš„è§¦å‘åœºæ™¯ï¼ˆå¦‚æµ‹è¯•ã€ä¸Šç”µè‡ªæ£€ï¼‰å’Œå…·ä½“çš„æŠ¥é”™å¯¹è±¡åŠé”™è¯¯ç ã€‚
2. ã€I - Interventions (æ’æŸ¥åŠ¨ä½œä¸ç»“æœ)ã€‘å¿…é¡»ä½“ç°â€œæ§åˆ¶å˜é‡æ³•â€æˆ–â€œäº¤å‰éªŒè¯â€ã€‚å¦‚æœå·¥ç¨‹å¸ˆç”³è¯·æ›´æ¢äº†æ ¸å¿ƒéƒ¨ä»¶ï¼Œè®°å½•ä¸­å¿…é¡»åŒ…å«éªŒè¯è¯¥éƒ¨ä»¶æŸåçš„äº¤å‰æµ‹è¯•åŠ¨ä½œï¼ˆå¦‚ï¼šå¯¹è°ƒåæŠ¥é”™è·Ÿéšéƒ¨ä»¶è½¬ç§»ï¼‰ã€‚åªæ¢ä»¶ä¸éªŒè¯å¿…é¡»æ‹¦æˆªï¼
3. ã€A - As-is (å½“å‰ç°çŠ¶ä¸ç»“è®º)ã€‘å¿…é¡»æ˜ç¡®å½“å‰æœºå™¨çš„æœ€æ–°çŠ¶æ€æˆ–æœ€ç»ˆçš„éªŒæ”¶ç»“æœã€‚

# Action Rules (æ‰§è¡Œè§„åˆ™)
æ ¹æ®å·¥ç¨‹å¸ˆå½“å‰çš„è¾“å…¥å’Œå†å²å¯¹è¯ï¼Œåˆ¤æ–­ï¼š

**æƒ…å†µ Aï¼šä¿¡æ¯ä¸å…¨æˆ–å­˜åœ¨é€»è¾‘æ–­å±‚ï¼ˆè¿›å…¥â€œè¿½é—®æ¨¡å¼â€ï¼‰**
- åŠ¨ä½œï¼šæŒ‡å‡ºç¼ºå¤±çš„ç¯èŠ‚ï¼Œå¹¶æå‡º 1-2 ä¸ªæå…¶å…·ä½“çš„ç–‘é—®ã€‚
- è¯­æ°”ï¼šé€šä¿—ã€å¹³çº§åä½œã€ç›´å¥”ä¸»é¢˜ï¼ˆä¾‹å¦‚ï¼šâ€œè¾›è‹¦ç¡®è®¤ä¸€ä¸‹ï¼Œæ¢ä¸»æ¿å‰æœ‰æŠŠ GPU æ’åˆ°åˆ«çš„æ§½ä½äº¤å‰éªŒè¯è¿‡å—ï¼Ÿâ€ï¼‰ã€‚ç»å¯¹ä¸è¦é•¿ç¯‡å¤§è®ºã€‚

**æƒ…å†µ Bï¼šä¿¡æ¯å®Œæ•´ä¸”é€»è¾‘é—­ç¯æ»¡è¶³ PIA æ¨¡å‹ï¼ˆè¿›å…¥â€œç”Ÿæˆæ¨¡å¼â€ï¼‰**
- åŠ¨ä½œï¼šåœæ­¢æé—®ï¼Œç›´æ¥è¾“å‡ºä¸€ä»½ç»“æ„åŒ–çš„æœ€ç»ˆæŠ¥å‘Šã€‚
- æŠ¥å‘Šæ ¼å¼ï¼šä¸¥æ ¼æŒ‰ç…§ã€ä¸€ã€åˆå§‹æ•…éšœç°è±¡ã€‘ã€ã€äºŒã€æ’æŸ¥è¿‡ç¨‹ä¸é€»è¾‘é—­ç¯ã€‘ã€ã€ä¸‰ã€æœ€ç»ˆç»“æœä¸éªŒæ”¶ç¡®è®¤ã€‘ä¸‰ä¸ªæ¨¡å—è¾“å‡ºã€‚
- âš ï¸ å¼ºåˆ¶è§„å®šï¼šå½“ä½ åˆ¤æ–­å¯ä»¥ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šæ—¶ï¼Œä½ çš„å›å¤å¿…é¡»ä¸”åªèƒ½ä»¥â€œã€æœ€ç»ˆäº¤ä»˜æŠ¥å‘Šã€‘â€è¿™å…­ä¸ªå­—ä½œä¸ºå¼€å¤´ï¼
"""

# 3. åˆå§‹åŒ–ä¼šè¯çŠ¶æ€ (è®°å¿†åŠŸèƒ½)
if "messages" not in st.session_state:
    # éšè—çš„ç³»ç»Ÿçº§è®°å¿†ï¼Œè´Ÿè´£ç»™å¤§æ¨¡å‹ç«‹è§„çŸ©
    st.session_state.messages = [{"role": "system", "content": SYSTEM_PROMPT}]
    # å‘ˆç°åœ¨å‰ç«¯çš„å¯¹è¯è®°å½•
    st.session_state.display_messages = [
        {"role": "assistant", "content": "ä½ å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½å·¥å•å¤æ ¸åŠ©æ‰‹ã€‚è¯·æŠŠç°åœºçš„**æ’æŸ¥æµæ°´è´¦**å‘ç»™æˆ‘ï¼Œæˆ‘ä¼šåŸºäº PIA æ¨¡å‹ï¼ˆç°è±¡-æ’æŸ¥åŠ¨ä½œ-ç°çŠ¶ï¼‰å¸®ä½ æŸ¥æ¼è¡¥ç¼ºã€‚å¦‚æœæœªè¿›è¡Œäº¤å‰éªŒè¯ï¼Œæˆ‘å¯æ˜¯ä¼šæ‰“å›æ¥çš„å“¦ï¼"}
    ]
    st.session_state.is_done = False # è®°å½•æ˜¯å¦å·²æˆåŠŸç”ŸæˆæŠ¥å‘Š

# 4. æ¸²æŸ“å‰ç«¯å†å²å¯¹è¯è®°å½•
for msg in st.session_state.display_messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# 5. æ ¸å¿ƒäº¤äº’å¾ªç¯
# å¦‚æœè¿˜æ²¡ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šï¼Œå°±ä¸€ç›´æ˜¾ç¤ºè¾“å…¥æ¡†è®©å·¥ç¨‹å¸ˆè¡¥å……
if not st.session_state.is_done:
    if prompt := st.chat_input("è¯·è¾“å…¥ç°åœºæ’æŸ¥è®°å½•æˆ–è¡¥å……å›ç­”..."):
        # å°†å·¥ç¨‹å¸ˆçš„è¾“å…¥æ˜¾ç¤ºåœ¨å±å¹•ä¸Š
        st.session_state.display_messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)
        
        # å°†è¾“å…¥æ‚„æ‚„åŠ å…¥ç³»ç»Ÿè®°å¿†ä¸­
        st.session_state.messages.append({"role": "user", "content": prompt})

        # å‘¼å«å¤§æ¨¡å‹è¿›è¡Œé€»è¾‘è£å†³
        with st.chat_message("assistant"):
            with st.spinner("Agent æ­£åœ¨æ¨æ¼” PIA é€»è¾‘æ˜¯å¦é—­ç¯..."):
                try:
                    response = client.chat.completions.create(
                        model="moonshot-v1-8k",
                        messages=st.session_state.messages,
                        temperature=0.2, # é™ä½æ¸©åº¦ï¼Œè®© AI æ›´åŠ ä¸¥è°¨å®¢è§‚ï¼Œä¸å‘æ•£
                    )
                    reply = response.choices[0].message.content
                    
                    # ã€æ ¸å¿ƒæœºå…³ã€‘ï¼šæ£€æµ‹ AI æ˜¯å¦å†³å®šæ”¾è¡Œ
                    if "ã€æœ€ç»ˆäº¤ä»˜æŠ¥å‘Šã€‘" in reply:
                        st.success("ğŸ‰ é€»è¾‘å·²å®Œç¾é—­ç¯ï¼Agent å·²æ”¾è¡Œå¹¶ç”Ÿæˆæ ‡å‡†äº¤ä»˜æŠ¥å‘Šã€‚")
                        st.session_state.is_done = True # è§¦å‘å¼€å…³ï¼Œé”å®šè¾“å…¥æ¡†
                        
                    st.markdown(reply)
                    
                    # å°† AI çš„å›å¤å­˜å…¥è®°å¿†
                    st.session_state.messages.append({"role": "assistant", "content": reply})
                    st.session_state.display_messages.append({"role": "assistant", "content": reply})
                    
                    # å¦‚æœåˆšæ‰åˆ¤å®šå®Œæˆäº†ï¼Œåˆ·æ–°ä¸€æ¬¡é¡µé¢ä»¥éšè—è¾“å…¥æ¡†å¹¶æ˜¾ç¤ºé‡æ–°å¼€å§‹æŒ‰é’®
                    if st.session_state.is_done:
                        st.rerun()

                except Exception as e:
                    st.error(f"è°ƒç”¨ API å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Keyï¼š{e}")

# 6. æŠ¥å‘Šç”Ÿæˆåçš„é‡ç½®åŠ¨ä½œ
if st.session_state.is_done:
    st.markdown("---")
    if st.button("âœ¨ å½’æ¡£å¹¶å¤„ç†ä¸‹ä¸€ä¸ªå·¥å•", type="primary", use_container_width=True):
        # æ¸…ç©ºè®°å¿†ï¼Œé‡æ–°å¼€å§‹
        del st.session_state.messages
        del st.session_state.display_messages
        del st.session_state.is_done
        st.rerun()
